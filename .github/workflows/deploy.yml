name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Serverga ulanish va pull qilish
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            sudo -i << 'EOF'
            cd /var/www/Khamrayev-Filters-Backend

            # Git konfiguratsiyasi

            # Konflikt bo‘lsa, eski kodlarni inkor qilish
            git fetch origin main
            git reset --hard origin/main

            # Virtual muhitni faollashtirish va yangilash
            source venv/bin/activate
            pip install -r requirements.txt
            python manage.py migrate
            python manage.py collectstatic --noinput

            # Xizmatlarni qayta ishga tushirish
            systemctl restart gunicorn
            systemctl restart nginx
            EOF
      - name: Send notification to Telegram after deployment
        run: |
          curl -X POST "https://api.telegram.org/bot7399847827:AAG5tD_qQU8qIktxVMRMkHoWZENLRU9HnQ4/sendMessage" \
          -d "chat_id=-1002289045305" \
          -d "parse_mode=MarkdownV2" \
          -d "text=✅ *Khamrayev Backend обновлен успешно\!*%0A%0A\
          🔄 *Код успешно загружен и обновлен на сервере*%0A\
          📌 *Ветка:* \`${{ github.ref_name }}\`%0A\
          🔗 [Просмотр репозитория](https://github.com/${{ github.repository }})"